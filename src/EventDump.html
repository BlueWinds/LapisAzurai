<!DOCTYPE html>
<meta charset="utf-8">
<head>
<style>
  body {
    max-width: 960px;
    margin-left: auto;
    margin-right: auto;
    width: 90%;
  }

  #index {
    margin: auto;
    width: 20%;
  }

  img {
    float: left;
    max-width: 300px;
    max-height: 200px;
    margin: 0 15px 10px 0;
  }

  section {
    clear: both;
    margin-bottom: 20px;
  }

  hr {
    clear: both;
    margin-top: 20px;
  }

  h1 {
    border-top: 5px solid black;
    clear: both;
    margin-top: 60px;
    padding-top: 30px;
    text-align: center;
  }

  h2 {
    margin-bottom: 5px;
  }

  h4 {
    margin: 10px;
  }
</style>
<script src="../dist/game/lib.js"></script>
<script src="../dist/game/compiled.js"></script>
<script src="http://localhost:35729/livereload.js"></script>
<script>
  window.g = {history: {}, people: {}}

  function drawEvents(chapter) {
    var index = $('#index').empty()
    var w = $('#warnings').empty()
    var s = $('#stories').empty()

    for (let chapter in Place.Vailia.stories) {
      index.append('<h2>' + chapter + '</h2>')
      for (let place in Place) {
        if (!Place[place].stories || !Place[place].stories[chapter] || !Place[place].stories[chapter].length) { continue; }

        index.append('<h4>' + place + '</h4>')
        Place[place].stories[chapter].forEach(drawStory);
      }
    }

    function drawStory(story) {
      if (!Story[story].text) { return; }

      const link = '<a href="#' + story + '">' + story + '</a>';

      if (!Story[story].label) {
        w.append('<li>' + link + ' is missing a label</li>');
      }

      var history = Story[story].history
      for (prereq in history) {
        if (history[prereq] !== -1 && history[prereq] < 20 && !Story[story].blocking) {
          w.append('<li>' + link + ' must be done within ' + history[prereq] + ' days of ' + prereq + ".</li>");
        }
      }

      sections = Story.render(story);
      sections.each(function(i) {
        section = $(this).attr('id', story + i)
        const i_link = '<a href="#' + story + i + '">' + story + '[' + i + ']</a>';
        len = section.text().length;

        if (section.find('img').length && len < 200) {
          w.append('<li>' + i_link + ' has an image, but is only ' + len + ' characters long.</li>');
        }

        if (len > 1800) {
           w.append('<li>' + i_link + ' is ' + len + ' characters long, consider breaking it up.</li>');
        }

        section.find('img').on('error', function(e) {
          w.prepend('<li>' + i_link + ' wanted invalid image "' + decodeURI(this.src.split('content/')[1]) + '"</li>');
        });
      });

      index.append('<li>' + link + '</li>');
      s.append('<h1 id="' + story + '">' + story + ' <a href="#">^</a></h1>');
      s.append(sections);
    }

    $('img').each(function() {
      this.src = this.src.replace('game/content', 'content')
    })
  }
</script>
</head>
<body onload="drawEvents('Ch1')">
  <ul id="warnings"></ul>
  <ul id="index"></ul>
  <div id="stories"></div>
</body>
